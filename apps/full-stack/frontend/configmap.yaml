apiVersion: v1
kind: ConfigMap
metadata:
  name: swagger-config
  namespace: full-stack
data:
  swagger-initializer.js: |
    window.onload = function() {
      window.ui = SwaggerUIBundle({
        url: "https://api-route-full-stack.apps.lab.local/", 
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIStandalonePreset
        ],
        layout: "StandaloneLayout",
        oauth2RedirectUrl: "https://frontend-route-full-stack.apps.lab.local/oauth2-redirect.html",
        
        onComplete: function() {
          var spec = ui.specSelectors.specJson().toJS();
          var authUrl = "https://keycloak-route-full-stack.apps.lab.local/realms/lab-realm/protocol/openid-connect/auth";
          
          // --- DETECCIÓN INTELIGENTE DE VERSIÓN ---
          
          if (spec.swagger && spec.swagger.startsWith("2")) {
            // CASO 1: Es SWAGGER 2.0 (Tu caso actual)
            console.log("Detectado Swagger 2.0 - Aplicando configuración legacy");
            spec.securityDefinitions = {
              "keycloak": {
                "type": "oauth2",
                "flow": "implicit", 
                "authorizationUrl": authUrl,
                "scopes": {
                  "openid": "OpenID Connect",
                  "profile": "User Profile"
                }
              }
            };
          } else {
            // CASO 2: Es OPENAPI 3.0 (PostgREST moderno)
            console.log("Detectado OpenAPI 3.0 - Aplicando configuración moderna");
            if (!spec.components) spec.components = {};
            if (!spec.components.securitySchemes) spec.components.securitySchemes = {};
            
            spec.components.securitySchemes["keycloak"] = {
              "type": "oauth2",
              "flows": {
                "implicit": {
                  "authorizationUrl": authUrl,
                  "scopes": { "openid": "OpenID Connect", "profile": "User Profile" }
                }
              }
            };
          }
          
          // Aplicar seguridad globalmente (Compatible con ambas versiones)
          spec.security = [{"keycloak": ["openid", "profile"]}];
          
          // Actualizar y refrescar
          ui.specActions.updateSpec(JSON.stringify(spec));
          
          ui.initOAuth({
            clientId: "swagger-client",
            realm: "lab-realm",
            appName: "FullStack Lab",
            scopes: "openid profile"
          });
        }
      });
    };